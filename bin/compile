#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

if [[ $(uname) == "Darwin" ]]; then
    sedf() { command sed -l "$@"; }
else
    sedf() { command sed -u "$@"; }
fi

indent() {
  sedf "s/^/       /"
}

tolower() {
    echo "$@" | tr "[:upper:]" "[:lower:]"
}

header(){
  echo "-----> $1"
}

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
env_dir="$3"
arch=$(tolower $(uname -m))
if [[ $arch == "x86_64" ]]; then
    arch="amd64"
fi
plat=$(tolower $(uname))-$arch

if [[ -e $build/bin && ! -d $build/bin ]]; then
    echo >&2 " !     File bin exists and is not a directory."
    exit 1
fi

header "Downloading mongo-mools"
FILE="mongodb-org-tools_3.2.11_amd64.deb"
curl "http://repo.mongodb.org/apt/ubuntu/dists/trusty/mongodb-org/3.2/multiverse/binary-${arch}/${FILE}" > "${cache}/${FILE}"

header "Installing mongo-mools"
dpkg -i "${cache}/${FILE}"

header "Cleaning up"
rm -rf "${cache:?}/$FILE"

header "Mongo Tools Buildpack Complete"
